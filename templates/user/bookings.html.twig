{% extends 'base.html.twig' %}

{% block title %}My Bookings ‚Äî ARTEUM{% endblock %}

{% block body %}
<div class="fixed inset-0 bg-gradient-to-b from-[#2d2d2d] via-[#242424] to-[#161616] -z-10"></div>
<div class="fixed inset-0 opacity-40 bg-[radial-gradient(ellipse_at_top,rgba(99,102,241,0.22),transparent_60%)] -z-10"></div>
<div class="fixed inset-0 opacity-20 bg-[radial-gradient(ellipse_at_bottom,rgba(236,72,153,0.18),transparent_55%)] -z-10"></div>

<div class="relative z-10 min-h-screen text-white py-12 px-4 sm:px-6 lg:px-8">
  <div class="max-w-6xl mx-auto">

    {# Top bar #}
    <header class="mb-8">
      <div class="flex flex-col lg:flex-row lg:items-end lg:justify-between gap-5">
        <div>
          <p class="text-xs tracking-[0.22em] text-neutral-400 uppercase">Your Account</p>

          <div class="mt-2 flex items-center gap-3">
            <h1 class="text-4xl sm:text-5xl font-extrabold tracking-tight">
              Your <span class="bg-clip-text text-transparent bg-gradient-to-r from-indigo-300 via-violet-300 to-pink-300">Bookings</span>
            </h1>
            <span class="hidden sm:inline-flex items-center rounded-full border border-white/10 bg-white/5 px-3 py-1 text-xs text-neutral-200">
              Live updates
              <span class="ml-2 inline-block h-2 w-2 rounded-full bg-emerald-400/90 shadow-[0_0_18px_rgba(52,211,153,0.45)]"></span>
            </span>
          </div>

          <p class="mt-3 text-sm text-neutral-300/80 max-w-2xl">
            Track your tour requests, check statuses, and open details anytime. Updates refresh automatically.
          </p>
        </div>

        <div class="flex flex-col sm:flex-row gap-2 sm:items-center">
          <a href="{{ path('app_user_dashboard') }}"
             class="group inline-flex items-center justify-center gap-2 px-4 py-2 rounded-xl bg-neutral-900/60 border border-neutral-700/70 hover:bg-neutral-800/70 hover:border-neutral-600 text-xs font-semibold transition
                    focus:outline-none focus-visible:ring-2 focus-visible:ring-indigo-400/70 focus-visible:ring-offset-2 focus-visible:ring-offset-black/30">
            <span class="opacity-70 group-hover:opacity-100 transition">‚Üê</span> Dashboard
          </a>

          <a href="{{ path('app_user_book_tour') }}"
             class="group inline-flex items-center justify-center gap-2 px-4 py-2 rounded-xl text-xs font-semibold shadow-lg shadow-black/30
                    bg-gradient-to-r from-indigo-600 to-violet-600 hover:from-indigo-500 hover:to-violet-500 transition
                    focus:outline-none focus-visible:ring-2 focus-visible:ring-violet-300/80 focus-visible:ring-offset-2 focus-visible:ring-offset-black/30">
            <span class="text-lg leading-none">+</span> Book a Tour
          </a>
        </div>
      </div>

      {# Stats + Search (shown if there are bookings; JS will also update counts live) #}
      <div id="bookings-toolbar" class="mt-6 grid grid-cols-1 lg:grid-cols-3 gap-4 {% if bookings is empty %}hidden{% endif %}">
        <div class="lg:col-span-2 grid grid-cols-1 sm:grid-cols-3 gap-3">
          <div class="rounded-2xl border border-white/10 bg-white/5 p-4 shadow-sm">
            <p class="text-xs text-neutral-400">Total</p>
            <p id="stat-total" class="mt-1 text-2xl font-bold">{{ bookings|length }}</p>
          </div>
          <div class="rounded-2xl border border-emerald-400/15 bg-emerald-500/10 p-4 shadow-sm">
            <p class="text-xs text-emerald-200/80">Confirmed</p>
            <p id="stat-confirmed" class="mt-1 text-2xl font-bold">‚Äî</p>
          </div>
          <div class="rounded-2xl border border-amber-400/15 bg-amber-500/10 p-4 shadow-sm">
            <p class="text-xs text-amber-200/80">Pending</p>
            <p id="stat-pending" class="mt-1 text-2xl font-bold">‚Äî</p>
          </div>
        </div>

        <div class="rounded-2xl border border-white/10 bg-white/5 p-4">
          <label class="text-xs text-neutral-300/80">Search</label>
          <div class="mt-2 flex items-center gap-2 rounded-xl bg-black/20 border border-white/10 px-3 py-2">
            <span class="text-neutral-400">‚åï</span>
            <input id="booking-search" type="text" placeholder="Name, exhibition, status‚Ä¶"
                   class="w-full bg-transparent outline-none text-sm placeholder:text-neutral-500
                          focus:outline-none" />
            <button id="clear-search"
                    class="hidden text-xs text-neutral-300 hover:text-white px-2 py-1 rounded-lg hover:bg-white/5 transition">
              Clear
            </button>
          </div>
          <p class="mt-2 text-[11px] text-neutral-400">Filters instantly ‚Äî no server request.</p>
        </div>
      </div>
    </header>

    {% if bookings is not empty %}
      {# Table (desktop) + Cards (mobile) wrapper #}
      <section class="rounded-2xl bg-[#232323]/75 border border-neutral-800/80 shadow-2xl shadow-black/40 overflow-hidden backdrop-blur">
        <div class="px-6 py-5 border-b border-neutral-800/80 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
          <div>
            <h2 class="text-lg font-semibold">Bookings</h2>
            <p class="text-xs text-neutral-400 mt-1">Your latest requests</p>
          </div>

          <div class="flex items-center gap-3 text-xs text-neutral-400">
            <span class="inline-flex items-center gap-2 rounded-full border border-white/10 bg-white/5 px-3 py-1">
              Auto-refresh <span class="text-neutral-200 font-semibold">4s</span>
            </span>
            <span id="last-updated" class="hidden sm:inline">‚Äî</span>
          </div>
        </div>

        {# Desktop table #}
        <div class="hidden md:block overflow-x-auto">
          <table class="min-w-full text-sm">
            <thead class="text-neutral-400 text-xs uppercase bg-black/10">
              <tr>
                <th class="px-6 py-3 text-left">Name</th>
                <th class="px-6 py-3 text-left">Date</th>
                <th class="px-6 py-3 text-left">Guests</th>
                <th class="px-6 py-3 text-left">Exhibition</th>
                <th class="px-6 py-3 text-left">Status</th>
                <th class="px-6 py-3 text-left">Action</th>
              </tr>
            </thead>

            <tbody id="bookings-tbody" class="divide-y divide-neutral-800/70">
              {% for booking in bookings %}
                <tr data-booking-id="{{ booking.id }}"
                    data-search="{{ (booking.name ~ ' ' ~ (booking.exhibition ? booking.exhibition.title : booking.requestedExhibition) ~ ' ' ~ booking.status)|lower }}"
                    class="hover:bg-white/5 transition">
                  <td class="px-6 py-4 font-medium text-white">
                    <div class="flex items-center gap-3">
                      <span class="inline-flex h-9 w-9 items-center justify-center rounded-xl bg-white/5 border border-white/10 text-xs text-neutral-200">
                        {{ booking.name ? booking.name|slice(0,1)|upper : '‚Ä¢' }}
                      </span>
                      <div>
                        <div class="font-semibold">{{ booking.name }}</div>
                        <div class="text-xs text-neutral-400">Booking #{{ booking.id }}</div>
                      </div>
                    </div>
                  </td>

                  <td class="px-6 py-4 text-neutral-200">
                    {{ booking.date ? booking.date|date('M d, Y') : '‚Äî' }}
                  </td>

                  <td class="px-6 py-4 text-neutral-200">
                    <span class="inline-flex items-center gap-2 rounded-full border border-white/10 bg-white/5 px-3 py-1">
                      üë• <span class="font-semibold">{{ booking.numberOfGuests }}</span>
                    </span>
                  </td>

                  <td class="px-6 py-4 text-neutral-200">
                    {% if booking.exhibition %}
                      <span class="line-clamp-1">{{ booking.exhibition.title }}</span>
                    {% elseif booking.requestedExhibition %}
                      <span class="line-clamp-1">{{ booking.requestedExhibition }}</span>
                    {% else %}
                      <span class="text-neutral-400">‚Äî No preference ‚Äî</span>
                    {% endif %}
                  </td>

                  <td class="px-6 py-4">
                    <span class="px-3 py-1 text-xs rounded-full font-semibold
                      {% if booking.status == 'confirmed' %}
                        bg-emerald-500/15 text-emerald-200 ring-1 ring-emerald-500/30
                      {% elseif booking.status == 'pending' %}
                        bg-amber-500/15 text-amber-200 ring-1 ring-amber-500/30
                      {% else %}
                        bg-rose-500/15 text-rose-200 ring-1 ring-rose-500/30
                      {% endif %}
                    ">
                      {{ booking.status|capitalize }}
                    </span>
                  </td>

                  <td class="px-6 py-4">
                    <a href="{{ path('app_user_booking_view', { id: booking.id }) }}"
                       class="inline-flex items-center gap-2 rounded-xl border border-white/10 bg-white/5 px-3 py-2
                              text-indigo-200 hover:text-white hover:bg-white/10 transition font-semibold
                              focus:outline-none focus-visible:ring-2 focus-visible:ring-indigo-300/70">
                      View details <span aria-hidden="true">‚Üí</span>
                    </a>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        {# Mobile cards #}
        <div id="bookings-cards" class="md:hidden p-4 space-y-3">
          {% for booking in bookings %}
            <div data-booking-id="{{ booking.id }}"
                 data-search="{{ (booking.name ~ ' ' ~ (booking.exhibition ? booking.exhibition.title : booking.requestedExhibition) ~ ' ' ~ booking.status)|lower }}"
                 class="rounded-2xl border border-white/10 bg-white/5 p-4 shadow-sm">
              <div class="flex items-start justify-between gap-3">
                <div>
                  <p class="text-sm font-semibold">{{ booking.name }}</p>
                  <p class="text-xs text-neutral-400 mt-1">
                    {{ booking.date ? booking.date|date('M d, Y') : '‚Äî' }} ¬∑ {{ booking.numberOfGuests }} guests
                  </p>
                </div>
                <span class="px-3 py-1 text-[11px] rounded-full font-semibold
                  {% if booking.status == 'confirmed' %}
                    bg-emerald-500/15 text-emerald-200 ring-1 ring-emerald-500/30
                  {% elseif booking.status == 'pending' %}
                    bg-amber-500/15 text-amber-200 ring-1 ring-amber-500/30
                  {% else %}
                    bg-rose-500/15 text-rose-200 ring-1 ring-rose-500/30
                  {% endif %}
                ">
                  {{ booking.status|capitalize }}
                </span>
              </div>

              <div class="mt-3 text-sm text-neutral-200">
                <span class="text-neutral-400">Exhibition:</span>
                {% if booking.exhibition %}
                  {{ booking.exhibition.title }}
                {% elseif booking.requestedExhibition %}
                  {{ booking.requestedExhibition }}
                {% else %}
                  <span class="text-neutral-400">‚Äî No preference ‚Äî</span>
                {% endif %}
              </div>

              <a href="{{ path('app_user_booking_view', { id: booking.id }) }}"
                 class="mt-4 inline-flex w-full items-center justify-center gap-2 rounded-xl
                        bg-gradient-to-r from-indigo-600 to-violet-600 hover:from-indigo-500 hover:to-violet-500
                        px-4 py-2.5 text-sm font-semibold shadow-lg shadow-black/25 transition">
                View details ‚Üí
              </a>
            </div>
          {% endfor %}
        </div>
      </section>

      {# Toast #}
      <div id="toast"
           class="pointer-events-none fixed bottom-5 left-1/2 -translate-x-1/2 opacity-0 translate-y-2 transition
                  rounded-full border border-white/10 bg-black/40 backdrop-blur px-4 py-2 text-xs text-neutral-100 shadow-lg">
        Updated
      </div>

    {% else %}
      <div class="rounded-2xl bg-[#232323]/75 border border-neutral-800 shadow-2xl shadow-black/40 p-10 text-center backdrop-blur">
        <div class="mx-auto inline-flex h-12 w-12 items-center justify-center rounded-2xl bg-white/5 border border-white/10">
          üìå
        </div>
        <p class="mt-4 text-neutral-100 text-lg font-semibold">No bookings yet</p>
        <p class="text-neutral-400 mt-2">When you book a tour, it will appear here automatically.</p>

        <div class="mt-6 flex flex-col sm:flex-row gap-3 justify-center">
          <a href="{{ path('app_user_book_tour') }}"
             class="inline-flex items-center justify-center bg-gradient-to-r from-indigo-600 to-violet-600 hover:from-indigo-500 hover:to-violet-500
                    text-white font-semibold py-2.5 px-5 rounded-xl shadow transition">
            Book a tour
          </a>

          <a href="{{ path('app_user_dashboard') }}"
             class="inline-flex items-center justify-center bg-neutral-900/60 border border-neutral-700 hover:bg-neutral-800
                    text-white font-semibold py-2.5 px-5 rounded-xl transition">
            Back to Dashboard
          </a>
        </div>
      </div>
    {% endif %}
  </div>
</div>
{% endblock %}

{% block javascripts %}
  {{ parent() }}

  <script>
    (function () {
      const tbody = document.getElementById('bookings-tbody');
      const cards = document.getElementById('bookings-cards');
      const toast = document.getElementById('toast');
      const lastUpdated = document.getElementById('last-updated');

      const statTotal = document.getElementById('stat-total');
      const statConfirmed = document.getElementById('stat-confirmed');
      const statPending = document.getElementById('stat-pending');

      const search = document.getElementById('booking-search');
      const clearBtn = document.getElementById('clear-search');

      // If no bookings, nothing to enhance.
      if (!tbody && !cards) return;

      let lastSignature = '';
      let toastTimer = null;

      function showToast(message) {
        if (!toast) return;
        toast.textContent = message || 'Updated';
        toast.classList.remove('opacity-0', 'translate-y-2');
        toast.classList.add('opacity-100', 'translate-y-0');
        clearTimeout(toastTimer);
        toastTimer = setTimeout(() => {
          toast.classList.add('opacity-0', 'translate-y-2');
          toast.classList.remove('opacity-100', 'translate-y-0');
        }, 1400);
      }

      function humanTime() {
        const d = new Date();
        return d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      }

      function statusBadge(status) {
        const s = (status || '').toLowerCase();
        const cls =
          s === 'confirmed'
            ? 'bg-emerald-500/15 text-emerald-200 ring-1 ring-emerald-500/30'
            : s === 'pending'
              ? 'bg-amber-500/15 text-amber-200 ring-1 ring-amber-500/30'
              : 'bg-rose-500/15 text-rose-200 ring-1 ring-rose-500/30';

        const label = s ? s.charAt(0).toUpperCase() + s.slice(1) : '‚Äî';
        return `<span class="px-3 py-1 text-xs rounded-full font-semibold ${cls}">${label}</span>`;
      }

      function exhibitionText(b) {
        return b.exhibitionTitle || b.requestedExhibition || '‚Äî No preference ‚Äî';
      }

      function rowHtml(b) {
        const viewUrl = "{{ path('app_user_booking_view', { id: 'BOOKING_ID' }) }}".replace('BOOKING_ID', b.id);
        const dateText = (b.date || '');

        const searchText = `${b.name || ''} ${exhibitionText(b)} ${b.status || ''}`.toLowerCase();

        return `
          <tr data-booking-id="${b.id}" data-search="${searchText}"
              class="hover:bg-white/5 transition">
            <td class="px-6 py-4 font-medium text-white">
              <div class="flex items-center gap-3">
                <span class="inline-flex h-9 w-9 items-center justify-center rounded-xl bg-white/5 border border-white/10 text-xs text-neutral-200">
                  ${(b.name || '‚Ä¢').slice(0,1).toUpperCase()}
                </span>
                <div>
                  <div class="font-semibold">${b.name || ''}</div>
                  <div class="text-xs text-neutral-400">Booking #${b.id}</div>
                </div>
              </div>
            </td>
            <td class="px-6 py-4 text-neutral-200">${dateText || '‚Äî'}</td>
            <td class="px-6 py-4 text-neutral-200">
              <span class="inline-flex items-center gap-2 rounded-full border border-white/10 bg-white/5 px-3 py-1">
                üë• <span class="font-semibold">${(b.numberOfGuests ?? '')}</span>
              </span>
            </td>
            <td class="px-6 py-4 text-neutral-200">${exhibitionText(b)}</td>
            <td class="px-6 py-4">${statusBadge(b.status)}</td>
            <td class="px-6 py-4">
              <a href="${viewUrl}"
                 class="inline-flex items-center gap-2 rounded-xl border border-white/10 bg-white/5 px-3 py-2
                        text-indigo-200 hover:text-white hover:bg-white/10 transition font-semibold">
                View details <span aria-hidden="true">‚Üí</span>
              </a>
            </td>
          </tr>
        `;
      }

      function cardHtml(b) {
        const viewUrl = "{{ path('app_user_booking_view', { id: 'BOOKING_ID' }) }}".replace('BOOKING_ID', b.id);
        const dateText = (b.date || '‚Äî');
        const searchText = `${b.name || ''} ${exhibitionText(b)} ${b.status || ''}`.toLowerCase();

        return `
          <div data-booking-id="${b.id}" data-search="${searchText}"
               class="rounded-2xl border border-white/10 bg-white/5 p-4 shadow-sm">
            <div class="flex items-start justify-between gap-3">
              <div>
                <p class="text-sm font-semibold">${b.name || ''}</p>
                <p class="text-xs text-neutral-400 mt-1">${dateText} ¬∑ ${(b.numberOfGuests ?? '')} guests</p>
              </div>
              ${statusBadge(b.status).replace('text-xs','text-[11px]')}
            </div>

            <div class="mt-3 text-sm text-neutral-200">
              <span class="text-neutral-400">Exhibition:</span> ${exhibitionText(b)}
            </div>

            <a href="${viewUrl}"
               class="mt-4 inline-flex w-full items-center justify-center gap-2 rounded-xl
                      bg-gradient-to-r from-indigo-600 to-violet-600 hover:from-indigo-500 hover:to-violet-500
                      px-4 py-2.5 text-sm font-semibold shadow-lg shadow-black/25 transition">
              View details ‚Üí
            </a>
          </div>
        `;
      }

      function updateStats(bookings) {
        if (!statTotal || !statConfirmed || !statPending) return;
        const confirmed = bookings.filter(b => (b.status || '').toLowerCase() === 'confirmed').length;
        const pending = bookings.filter(b => (b.status || '').toLowerCase() === 'pending').length;

        statTotal.textContent = bookings.length;
        statConfirmed.textContent = confirmed;
        statPending.textContent = pending;
      }

      function applyFilter() {
        if (!search) return;
        const q = (search.value || '').trim().toLowerCase();
        if (clearBtn) clearBtn.classList.toggle('hidden', q.length === 0);

        const filterNodes = (root) => {
          if (!root) return;
          [...root.querySelectorAll('[data-search]')].forEach(el => {
            const hay = (el.getAttribute('data-search') || '');
            el.classList.toggle('hidden', q && !hay.includes(q));
          });
        };

        // Works for both desktop rows and mobile cards
        filterNodes(document);
      }

      if (search) {
        search.addEventListener('input', applyFilter);
      }
      if (clearBtn) {
        clearBtn.addEventListener('click', () => {
          search.value = '';
          applyFilter();
          search.focus();
        });
      }

      async function refreshBookings() {
        try {
          const res = await fetch("{{ path('app_user_bookings_json') }}", {
            headers: { 'Accept': 'application/json' }
          });
          if (!res.ok) return;

          const data = await res.json();
          const bookings = data.bookings || [];

          const sig = bookings.map(b => `${b.id}:${b.updatedAt || ''}`).join('|');
          if (sig === lastSignature) return;
          lastSignature = sig;

          updateStats(bookings);

          if (tbody) tbody.innerHTML = bookings.map(rowHtml).join('');
          if (cards) cards.innerHTML = bookings.map(cardHtml).join('');

          applyFilter();

          if (lastUpdated) {
            lastUpdated.textContent = `Updated ${humanTime()}`;
            lastUpdated.classList.remove('hidden');
          }
          showToast('Updated');
        } catch (e) {}
      }

      // Initial stats pass for server-rendered list (if JSON refresh hasn't run yet)
      try {
        const initialRows = document.querySelectorAll('[data-booking-id]');
        if (statConfirmed && statPending) {
          let c = 0, p = 0;
          initialRows.forEach(r => {
            const s = (r.getAttribute('data-search') || '');
            if (s.includes('confirmed')) c++;
            if (s.includes('pending')) p++;
          });
          statConfirmed.textContent = c;
          statPending.textContent = p;
        }
      } catch (e) {}

      refreshBookings();
      setInterval(refreshBookings, 4000);
    })();
  </script>
{% endblock %}
